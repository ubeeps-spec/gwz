{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Dashboard Container */
    .dashboard-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Filter Bar */
    .filter-bar {
        background: #fff;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* Buttons */
    .btn {
        padding: 8px 15px;
        border: 1px solid #ddd;
        background: #fff;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
        color: #333;
        transition: all 0.2s;
    }
    .btn:hover {
        background: #f8f9fa;
        border-color: #ccc;
    }
    .btn.active {
        background: #007bff;
        color: #fff;
        border-color: #0056b3;
    }
    
    .btn-group {
        display: flex;
        gap: 5px;
    }
    
    .date-input {
        padding: 7px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .btn-export {
        background: #28a745;
        color: #fff;
        border-color: #218838;
    }
    .btn-export:hover {
        background: #218838;
    }
    
    .filter-form select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        font-size: 14px;
    }
    .date-range-display {
        font-weight: bold;
        color: #555;
    }

    /* Stats Cards */
    .dashboard-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    .stat-card {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        flex: 1;
        min-width: 200px;
        text-align: center;
        border-left: 5px solid #007bff;
    }
    .stat-card:nth-child(2) { border-left-color: #28a745; }
    .stat-card:nth-child(3) { border-left-color: #17a2b8; }

    .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
    }
    .stat-label {
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Grid Layout */
    .dashboard-row {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    .dashboard-col {
        flex: 1;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        min-width: 300px;
    }

    /* Tables */
    h2 { 
        margin-top: 0; 
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
        font-size: 1.2em;
        color: #333;
    }
    table.report-table { width: 100%; border-collapse: collapse; }
    table.report-table th, table.report-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    table.report-table th { background: #f8f9fa; font-weight: 600; color: #495057; }
    table.report-table tr:hover { background-color: #f1f1f1; }
    
    .text-right { text-align: right !important; }
    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        background: #eee;
    }

    /* Print Styles */
    @media print {
        #header, .breadcrumbs, .filter-bar { display: none; }
        .dashboard-container { width: 100%; max-width: none; }
        .dashboard-col, .stat-card { box-shadow: none; border: 1px solid #ccc; }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <!-- Filter Bar -->
    <div class="filter-bar">
        <form method="get" class="filter-form" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; width: 100%;">
            
            <div class="btn-group">
                <button type="submit" name="period" value="year" class="btn {% if period == 'year' %}active{% endif %}">{% trans "Year" %}</button>
                <button type="submit" name="period" value="last_month" class="btn {% if period == 'last_month' %}active{% endif %}">{% trans "Last Month" %}</button>
                <button type="submit" name="period" value="this_month" class="btn {% if period == 'this_month' %}active{% endif %}">{% trans "This Month" %}</button>
                <button type="submit" name="period" value="7days" class="btn {% if period == '7days' %}active{% endif %}">{% trans "Last 7 Days" %}</button>
            </div>

            <select name="product_id" onchange="this.form.submit()" style="padding: 7px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; min-width: 200px; max-width: 400px; margin-left: 10px; color: #333; background-color: #fff;">
                <option value="">{% trans "All Products" %}</option>
                {% for p in products %}
                <option value="{{ p.id }}" {% if selected_product_id == p.id %}selected{% endif %}>{{ p.name|truncatechars:50 }}</option>
                {% endfor %}
            </select>

            <div class="custom-date-group" style="display: flex; align-items: center; gap: 5px; margin-left: 10px;">
                <span style="font-weight: bold; color: #666;">{% trans "Custom:" %}</span>
                <input type="date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" class="date-input">
                <span>-</span>
                <input type="date" name="end_date" value="{{ end_date|date:'Y-m-d' }}" class="date-input">
                <button type="submit" name="period" value="custom" class="btn {% if period == 'custom' %}active{% endif %}">{% trans "Query" %}</button>
            </div>
            
            <div style="margin-left: auto; margin-right: 10px; color: #666; font-size: 0.9em;">
                 {{ start_date|date:"Y-m-d" }} ~ {{ end_date|date:"Y-m-d" }}
            </div>
            <button type="submit" name="export" value="true" class="btn btn-export">{% trans "Export CSV" %}</button>
        </form>
    </div>

    <!-- Stats Cards -->
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-label">{% trans "Total Revenue" %}</div>
            <div class="stat-value">HK${{ total_sales|floatformat:2|default:"0" }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">{% trans "Total Orders" %}</div>
            <div class="stat-value">{{ total_orders|default:"0" }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">{% trans "Average Order Value (AOV)" %}</div>
            <div class="stat-value">HK${{ avg_order_value|floatformat:2|default:"0" }}</div>
        </div>
    </div>

    <!-- Chart -->
    <div class="dashboard-row">
        <div class="dashboard-col" style="flex: 100%;">
            <h2>{% trans "Sales Trend Chart" %}</h2>
            <div style="height: 300px;">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Split Row -->
    <div class="dashboard-row">
        <!-- Top Products -->
        <div class="dashboard-col">
            <h2>{% trans "Top 10 Selling Products" %}</h2>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>{% trans "Product Name" %}</th>
                        <th>SKU</th>
                        <th class="text-right">{% trans "Quantity Sold" %}</th>
                        <th class="text-right">{% trans "Revenue" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in top_products %}
                    <tr>
                        <td>{{ item.product__name }}</td>
                        <td><span class="badge">{{ item.product__sku }}</span></td>
                        <td class="text-right">{{ item.total_qty }}</td>
                        <td class="text-right">HK${{ item.total_revenue|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4">{% trans "No data available" %}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Top Categories -->
        <div class="dashboard-col">
            <h2>{% trans "Top 10 Selling Categories" %}</h2>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>{% trans "Category Name" %}</th>
                        <th class="text-right">{% trans "Quantity Sold" %}</th>
                        <th class="text-right">{% trans "Revenue" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in top_categories %}
                    <tr>
                        <td>{{ item.product__categories__name }}</td>
                        <td class="text-right">{{ item.total_qty }}</td>
                        <td class="text-right">HK${{ item.total_revenue|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3">{% trans "No data available" %}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Daily Report Table -->
    <div class="dashboard-row">
        <div class="dashboard-col">
            <h2>{% trans "Daily Sales Report" %}</h2>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>{% trans "Date" %}</th>
                        <th class="text-right">{% trans "Orders" %}</th>
                        <th class="text-right">{% trans "Revenue" %}</th>
                        <th class="text-right">{% trans "Average Price" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in daily_report %}
                    <tr>
                        <td>{{ row.date|date:"Y-m-d (D)" }}</td>
                        <td class="text-right">{{ row.orders }}</td>
                        <td class="text-right">HK${{ row.sales|floatformat:2 }}</td>
                        <td class="text-right">
                            HK${{ row.avg|floatformat:2 }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4">{% trans "No data available" %}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('salesChart').getContext('2d');
        const salesData = {
            labels: {{ chart_labels|safe }},
            datasets: [{
                label: '{% trans "Daily Revenue" %}',
                data: {{ chart_data|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        };
        
        new Chart(ctx, {
            type: 'line',
            data: salesData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { return 'HK$' + value; }
                        }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return '{% trans "Revenue" %}: HK$' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}